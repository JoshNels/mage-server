<div class="arc-admin">
  <h1>ArcGIS Configuration</h1>
  <section class="arc-processing">
    <header>
      <h2>Processing <button class="edit-button" mat-icon-button (click)="onEditProcessing()"><mat-icon>edit_outline</mat-icon></button></h2>
      <p class="subheading">MAGE ArcGIS plugin processing settings.</p>
    </header>
    <div class="processing">
      <table class="processing-table">
        <tr>
          <th>Enabled
            <button class="info-button" mat-icon-button
              (click)="showInfo('Enabled', 'Process observations and send to configured ArcGIS feature layers')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.enabled}}</td>
        </tr>
        <tr>
          <th>Interval (s)
            <button class="info-button" mat-icon-button
              (click)="showInfo('Interval', 'Observation query and processing frequency time interval in seconds')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.intervalSeconds}}</td>
        </tr>
        <tr>
          <th>Startup Interval (s)
            <button class="info-button" mat-icon-button
              (click)="showInfo('Startup Interval', 'Startup interval in seconds to wait for feature layer processors to be ready')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.startupIntervalSeconds}}</td>
        </tr>
        <tr>
          <th>Update Interval (s)
            <button class="info-button" mat-icon-button
              (click)="showInfo('Update Interval', 'Processing wait time interval in seconds when pending observation updates exist')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.updateIntervalSeconds}}</td>
        </tr>
        <tr>
          <th>Batch Size
            <button class="info-button" mat-icon-button
              (click)="showInfo('Batch Size', 'Maximum number of observations to process during a single time interval')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.batchSize}}</td>
        </tr>
        <tr>
          <th>Attachment Modified Tolerance (ms)
            <button class="info-button" mat-icon-button
              (click)="showInfo('Attachment Modified Tolerance', 'Time tolerance in milliseconds to consider an attachment as modified compared to the observation')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.attachmentModifiedTolerance}}</td>
        </tr>
      </table>
    </div>
  </section>
  <section class="arc-service">
    <header>
      <h2>Feature Layers</h2>
      <p class="subheading">Add ArcGIS feature service urls and layers to sychronize MAGE data to.</p>
    </header>
    <div>
      <button mat-button mat-stroked-button color="primary" aria-label="Add ArcGIS feature layer"
        (click)="onAddLayer()">ADD ARCGIS LAYER</button>
    </div>
    <div class="arcLayers" *ngIf="!config.featureServices.length">
      <div class="arcLayer__value">
        There are no ArcGIS feature layers currently being synchronized.
      </div>
    </div>
    <div class="arcLayers" *ngFor="let arcLayer of config.featureServices">
      <ng-container>
        <div class="arcLayer">
          <div class="arcLayer__value">
            {{arcLayer.url}}
          </div>
          <div class="arcLayer__action">
            <button class="mat-hint" mat-icon-button aria-label="Delete ArcGIS layer"
              (click)="onDeleteLayer(arcLayer.url)"><mat-icon>delete_outline</mat-icon></button>
          </div>
        </div>
        <div class="featureLayers" *ngFor="let featureLayer of arcLayer.layers">
          <div class="featureLayer__value">
            {{featureLayer.layer}}
          </div>
        </div>
      </ng-container>
    </div>
  </section>
  <section class="arc-fields">
    <header>
      <h2>Attributes <button class="edit-button" mat-icon-button (click)="onEditAttributes()"><mat-icon>edit_outline</mat-icon></button></h2>
      <p class="subheading">MAGE Field to ArcGIS Attribute mappings.</p>
    </header>
    <div class="attributes">
      <table class="attributes-table">
        <tr>
          <th>Observation Id Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Observation Id Field', 'The ArcGIS layer text field attribute name to store the MAGE observation id')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.observationIdField}}</td>
        </tr>
        <tr>
          <th>Id Separator
            <button class="info-button" mat-icon-button
              (click)="showInfo('Id Separator', 'When event id field is not configured, the separator combining observation ids and event ids in the observation id field')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.idSeparator}}</td>
        </tr>
        <tr>
          <th>Event Id Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Event Id Field', 'The ArcGIS layer integer field attribute name to store the MAGE event id')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.eventIdField}}</td>
        </tr>
        <tr>
          <th>Last Edited Date Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Last Edited Date Field', 'The last edited date field attribute name on the ArcGIS layer')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.lastEditedDateField}}</td>
        </tr>
        <tr>
          <th>Event Name Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Event Name Field', 'The ArcGIS layer text field attribute name to store the MAGE event name')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.eventNameField}}</td>
        </tr>
        <tr>
          <th>User Id Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('User Id Field', 'The ArcGIS layer text field attribute name to store the MAGE user id')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.userIdField}}</td>
        </tr>
        <tr>
          <th>Username Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Username Field', 'The ArcGIS layer text field attribute name to store the MAGE username')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.usernameField}}</td>
        </tr>
        <tr>
          <th>User Display Name Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('User Display Name Field', 'The ArcGIS layer text field attribute name to store the MAGE user display name')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.userDisplayNameField}}</td>
        </tr>
        <tr>
          <th>Device Id Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Device Id Field', 'The ArcGIS layer text field attribute name to store the MAGE device id')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.deviceIdField}}</td>
        </tr>
        <tr>
          <th>Created At Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Created At Field', 'The ArcGIS layer date time field attribute name to store the MAGE created at date')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.createdAtField}}</td>
        </tr>
        <tr>
          <th>Last Modified Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Last Modified Field', 'The ArcGIS layer date time field attribute name to store the MAGE last modified date (may be the same as last edited date field if editable)')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.lastModifiedField}}</td>
        </tr>
        <tr>
          <th>Geometry Type Field
            <button class="info-button" mat-icon-button
              (click)="showInfo('Geometry Type Field', 'The ArcGIS layer text field attribute name to store the Esri geometry type')">
              <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
            </button>
          </th>
          <td>{{config.geometryType}}</td>
        </tr>
      </table>
    </div>
    <div class="fieldOverrides">
      Field Mappings
      <button class="info-button" mat-icon-button
        (click)="showInfo('Field Mappings', 'Override mappings between MAGE event form fields and ArcGIS attributes')">
        <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
      </button>
      <table class="fieldOverrides-table">
        <tr>
          <th>Event</th>
          <th>Form</th>
          <th>Field</th>
          <th>Attribute</th>
        </tr>
        <ng-container *ngFor="let event of keys(config.fieldAttributes)">
          <tr>
            <td>{{event}}</td>
          </tr>
          <ng-container *ngFor="let form of keys(config.fieldAttributes[event])">
            <tr>
              <td></td>
              <td>{{form}}</td>
            </tr>
            <ng-container *ngFor="let field of keys(config.fieldAttributes[event][form])">
              <tr>
                <td></td>
                <td></td>
                <td>{{field}}</td>
                <td>{{config.fieldAttributes[event][form][field]}}</td>
              </tr>
            </ng-container>
          </ng-container>
        </ng-container>
      </table>
    </div>
    <div class="attributeConfigurations">
      Attribute Settings
      <button class="info-button" mat-icon-button
        (click)="showInfo('Attribute Settings', 'Attribute settings including concatenation, value mappings, defaults, and omissions')">
        <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
      </button>
      <table class="attributeConfigurations-table">
        <tr>
          <th>Attribute</th>
          <th>Setting</th>
        </tr>
        <ng-container *ngFor="let attribute of keys(config.attributes)">
          <tr>
            <td>{{attribute}}</td>
          </tr>
          <ng-container *ngIf="hasConcatenation(attribute)">
            <tr>
              <td></td>
              <td>Concatenation
                <button class="info-button" mat-icon-button
                  (click)="showInfo('Concatenation', 'String value concatenation when an observation contains multiple attribute values')">
                  <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
                </button>
              </td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td>Delimiter
                <button class="info-button" mat-icon-button
                  (click)="showInfo('Delimiter', 'Delimiter used to combine attribute values')">
                  <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
                </button>
              </td>
              <td>{{getConcatenation(attribute).delimiter}}</td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td>Same Forms
                <button class="info-button" mat-icon-button
                  (click)="showInfo('Same Forms', 'Combine attribute values from multiple instances of the same MAGE form')">
                  <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
                </button>
              </td>
              <td>{{getConcatenation(attribute).sameForms}}</td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td>Different Forms
                <button class="info-button" mat-icon-button
                  (click)="showInfo('Different Forms', 'Combine attribute values from different MAGE forms')">
                  <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
                </button>
              </td>
              <td>{{getConcatenation(attribute).differentForms}}</td>
            </tr>
          </ng-container>
          <ng-container *ngIf="hasMappings(attribute)">
            <tr>
              <td></td>
              <td>Mappings
                <button class="info-button" mat-icon-button
                  (click)="showInfo('Mappings', 'Attribute value translation mappings performed before sending to ArcGIS')">
                  <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
                </button>
              </td>
            </tr>
            <ng-container *ngFor="let mapping of keys(getMappings(attribute))">
              <tr>
                <td></td>
                <td></td>
                <td>{{mapping}}</td>
                <td>{{getMappings(attribute)[mapping]}}</td>
              </tr>
            </ng-container>
          </ng-container>
          <ng-container *ngIf="hasDefaults(attribute)">
            <tr>
              <td></td>
              <td>Defaults
                <button class="info-button" mat-icon-button
                  (click)="showInfo('Defaults', 'Default values when the attribute is missing or has no value')">
                  <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
                </button>
              </td>
            </tr>
            <ng-container *ngFor="let default of getDefaults(attribute)">
              <tr>
                <td></td>
                <td></td>
                <td>{{default.value}}</td>
              </tr>
              <ng-container *ngIf="default.condition != undefined">
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>Conditions
                    <button class="info-button" mat-icon-button
                      (click)="showInfo('Conditions', 'Conditional attribute equality values when the default applies')">
                      <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
                    </button>
                  </td>
                </tr>
                <ng-container *ngFor="let condition of default.condition!">
                  <ng-container *ngFor="let value of condition.values">
                    <tr>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td>{{condition.attribute}}</td>
                      <td>{{value}}</td>
                    </tr>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
          <ng-container *ngIf="hasOmit(attribute)">
            <tr>
              <td></td>
              <td>Omit
                <button class="info-button" mat-icon-button
                  (click)="showInfo('Omit', 'Omit the attribute from being sent to ArcGIS')">
                  <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
                </button>
              </td>
              <td>{{getOmit(attribute)}}</td>
            </tr>
          </ng-container>
        </ng-container>
      </table>
    </div>
  </section>
</div>
<ng-template #addLayerDialog let-data>
  <h2 matDialogTitle>Add ArcGIS Layer</h2>
  <mat-dialog-content>
    <div class="arc-layer-form">
      <mat-form-field [style.width.%]="100">
        <mat-label>ArcGIS Feature Layer URL</mat-label>
        <input type="text" matInput [formControl]="arcLayerControl" (keyup)="inputChanged(layerUrl.value)"
          placeholder="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" #layerUrl />
        <mat-error *ngIf="arcLayerControl.hasError('required')">
          URL is <strong>required</strong>
        </mat-error>
      </mat-form-field>
    </div>
    <mat-spinner *ngIf="isLoading"></mat-spinner>
    <div class="arc-layers" *ngFor="let arcLayer of layers">
      <div class="featureLayer__value">
        {{arcLayer}}
      </div>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button matDialogClose>CANCEL</button>
    <button [disabled]="layers.length == 0" mat-flat-button color="primary" matDialogClose (click)="onAddLayerUrl(layerUrl.value, layers)">SAVE</button>
  </mat-dialog-actions>
</ng-template>
<ng-template #infoDialog let-data>
  <h3 matDialogTitle>{{infoTitle}}</h3>
  <mat-dialog-content>
    <div class="info-form">
      <mat-label>{{infoMessage}}</mat-label>
    </div>
  </mat-dialog-content>
</ng-template>
<ng-template #editProcessingDialog let-data>
  <h2 matDialogTitle>Processing Configuration</h2>
  <mat-dialog-content>
    <div class="edit-processing-form">
      <div class="edit-enabled-field">
        <mat-form-field>
          <mat-select placeholder="Enabled" [(value)]="editConfig.enabled" (selectionChange)="setField('enabled', $event.value)">
            <mat-option [value]="true">true</mat-option>
            <mat-option [value]="false">false</mat-option>
          </mat-select>
        </mat-form-field>
        <button class="info-button" mat-icon-button
          (click)="showInfo('Enabled', 'Process observations and send to configured ArcGIS feature layers')">
          <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
        </button>
      </div>
      <div class="edit-interval-field">
        <mat-form-field>
          <mat-label>Interval</mat-label>
          <input type="number" min="0" matInput value="{{editConfig.intervalSeconds}}" 
          (keyup)="setNumberField('intervalSeconds', intervalSecondsField.value, 0)" (change)="setNumberField('intervalSeconds', intervalSecondsField.value, 0)" #intervalSecondsField />
        </mat-form-field>
        <button class="info-button" mat-icon-button
          (click)="showInfo('Interval', 'Observation query and processing frequency time interval in seconds')">
          <mat-icon class="info-icon" [inline]="true">info_outline</mat-icon>
        </button>
      </div>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button matDialogClose (click)="cancelEdit()">CANCEL</button>
    <button mat-flat-button color="primary" matDialogClose (click)="saveEdit()">SAVE</button>
  </mat-dialog-actions>
</ng-template>
<ng-template #editAttributesDialog let-data>
  <h2 matDialogTitle>Attributes Configuration</h2>
  <mat-dialog-content>
    <div class="edit-attributes-form">
      <mat-form-field>
        <mat-label>Observation Id Field</mat-label>
        <input type="text" matInput value="{{editConfig.observationIdField}}" (keyup)="setField('observationIdField', observationIdField.value)" #observationIdField />
      </mat-form-field>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button matDialogClose (click)="cancelEdit()">CANCEL</button>
    <button mat-flat-button color="primary" matDialogClose (click)="saveEdit()">SAVE</button>
  </mat-dialog-actions>
</ng-template>