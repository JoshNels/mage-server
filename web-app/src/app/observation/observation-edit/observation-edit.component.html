<div #editForm>
  <mat-toolbar color="primary">
    <mat-toolbar-row class="navigation">
      <button mat-icon-button class="navigation__icon" (click)="cancel()"><mat-icon>close</mat-icon></button>
      <div class="navigation__title">
        <span *ngIf="!isNewObservation">Edit Observation</span>
        <span *ngIf="isNewObservation">Create Observation</span>
      </div>

      <button mat-button (click)="save()" [disabled]="observationForm.$invalid || saving || mask">SAVE</button>
    </mat-toolbar-row>
  </mat-toolbar>

  <mat-progress-bar *ngIf="saving" color="primary" mode="indeterminate" class="edit-progress"></mat-progress-bar>

  <div cdkScrollable #editContent class="edit-content" [ngClass]="{'edit-content--scroll-lock': mask}">
    <div class="edit-banner" *ngIf="error" @error>
      <div class="edit-banner-container">
        <div class="edit-banner-content">
          <div class="edit-banner-content__title">Invalid observation, correct the following errors.</div>
          <div class="edit-banner-content__summary">{{error?.message}}</div>
        </div>
      </div>
    
      <div class="edit-banner-actions">
        <button mat-button color="primary" (click)="error = null;">DISMISS</button>
      </div>
    </div>

    <form class="observation" name="observationForm" novalidate>
      <mat-card class="form">
        <observation-edit-date [formGroup]="formGroup.get('properties')" [definition]="timestampDefinition"></observation-edit-date>
      
        <observation-edit-geometry
          [formGroup]="formGroup"
          [definition]="geometryDefinition"
          [featureId]="observation.id"
          [featureStyle]="geometryStyle"
          (onFeatureEdit)="onGeometryEdit($event)">
        </observation-edit-geometry>
      </mat-card>

      <div *ngIf="!preview">
        <mat-card class="form">
          <div class="attachment-field">
            <div class="attachment-field__label">Attachments</div>
      
            <ng-container *ngIf="allAttachments().length; else empty">
              <mat-grid-list class="edit-attachments__grid" cols="2" rowHeight="210px" gutterSize="4px"
                *ngIf="allAttachments().length">
                <mat-grid-tile *ngFor="let attachment of allAttachments(); trackBy: trackByAttachment; first as isFirst"
                  [rowspan]="1" [colspan]="isFirst && (allAttachments().length % 2 === 1) ? 2 : 1">
                  <observation-attachment *ngIf="!attachment.file" [attachment]="attachment" [observation]="observation"
                    edit="true">
                  </observation-attachment>
                  <attachment-upload *ngIf="attachment.file" [url]="observation.url + '/attachments'"
                    [attachment]="attachment" [allowUpload]="uploadAttachments" (remove)="onAttachmentRemove($event)"
                    (error)="onAttachmentError($event)" (upload)="onAttachmentUploaded($event)"></attachment-upload>
                </mat-grid-tile>
              </mat-grid-list>
            </ng-container>
      
            <div class="attachment-actions">
              <button mat-button class="add__button" type="button" color="primary" (click)="file.click()">
                Add Attachment
              </button>
              <input [hidden]="true" type="file" #file multiple (change)="onAttachmentFile($event)">
            </div>
      
            <div class="attachment-field__underline"></div>
          </div>
        </mat-card>
      </div>

      <div class="edit-forms" cdkDropList cdkDropListLockAxis="y" (cdkDropListDropped)="reorderForm($event)">
        <ng-container *ngFor="let group of formGroup?.get('properties')?.get('forms')?.controls">
          <div class="form" #form cdkDrag cdkDragBoundary=".edit-forms">
            <observation-edit-form
              [formGroup]="group"
              [definition]="formDefinitions[group.get('formId').value]"
              [geometryStyle]="geometryStyle"
              [options]="formOptions"
              (remove)="removeForm($event)"
              (featureEdit)="onGeometryEdit($event)">

              <div *ngIf="formGroup?.get('properties')?.get('forms').length > 1" cdkDragHandle>
                <mat-icon class="form-drag-handle" svgIcon="handle"></mat-icon>
              </div>
            </observation-edit-form>
          </div>
        </ng-container>
      </div>
    </form>
  </div>

  <div class="add-form">
    <button class="extended-fab-button" mat-fab color="accent" (click)="pickForm()">
      <mat-icon>note_add</mat-icon>
      <span class="extended-fab-button__text">Add Form</span>
    </button>
  </div>

  <div *ngIf="mask" @mask class="form-mask"></div>
</div>

<ng-template #empty>
  <div class="no-attachments">
    <mat-icon class="no-attachments__icon">insert_drive_file</mat-icon>
    <div class="no-attachments__text">No Attachments</div>
  </div>
</ng-template>